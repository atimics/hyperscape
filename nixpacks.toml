# Nixpacks configuration for Railway deployment
# This file configures how Railway builds the Hyperscape game server (API only)
#
# ARCHITECTURE:
# - Frontend: Cloudflare Pages (hyperscape.club)
# - Server/API: Railway (hyperscape-production.up.railway.app)
# - Assets/CDN: Cloudflare R2

[phases.setup]
# Install system dependencies needed for native modules (canvas, better-sqlite3)
aptPkgs = [
  "python3",
  "make",
  "g++",
  "pkg-config",
  "libcairo2-dev",
  "libpango1.0-dev",
  "libjpeg-dev",
  "libgif-dev",
  "librsvg2-dev",
  "ca-certificates"
]

[phases.install]
# Use bun for package installation
cmds = ["bun install"]

[phases.build]
# Build only shared and server packages (frontend is on Cloudflare Pages)
# Uses Turbo for caching - Railway preserves node_modules and .turbo between builds
dependsOn = ["install"]
cmds = [
  "echo '=== Building with Turbo cache ==='",
  "bunx turbo run build --filter=@hyperscape/shared --filter=@hyperscape/server --cache-dir=.turbo",
  "echo '=== Creating manifests directory ==='",
  "mkdir -p packages/server/world/assets/manifests",
  "echo '=== Build complete ==='",
]

[start]
cmd = "cd packages/server && bun dist/index.js"

[variables]
# Skip asset download in CI - assets are served from Cloudflare R2 CDN
CI = "true"
SKIP_ASSETS = "true"
NODE_ENV = "production"

# Cache directories between builds for faster rebuilds
[caches]
node_modules = true
".turbo" = true
"packages/shared/build" = true
"packages/server/dist" = true
